<%= link_to 'Edit Import', edit_import_path(@import) %> |
<%= link_to 'Back', imports_path %>

<div class="row">
  <div class="col-md-6">
    <h1>Import</h1>
    <p>
      <strong>Name:</strong>
      <%= @import.name %>
    </p>

    <p>
      <strong>Filename:</strong>
      <%= @import.filename %> (<%= @import.content_type %>)
    </p>

    <p>
      <strong>State:</strong>
      <%= @import.state_machine.current_state %>
    </p>

    <p>
      <strong>Source:</strong>
      <%= @import.source %>
    </p>

    <p>
      <strong>Description:</strong>
      <%= @import.description %>
    </p>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-header text-center">
        <h3 class="h5">CSV Row Count</h3>
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item text-center">
          <%= @import.row_count %>
        </li>
      </ul>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card">
      <div class="card-header text-center">
        <h3 class="h5">Imported Documents</h3>
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item text-center">
          <% if @import.state_machine.current_state == 'mapped' %>
            <%= form_tag run_import_path(@import), method: :patch do -%>
              <%= hidden_field_tag :run, true -%>
              <%= submit_tag 'Run Import' -%>
            <%- end -%>
          <% end %>
          <% if @import.state_machine.current_state == 'imported' %>
            <%= @import.documents.size %>
          <% end %>
        </li>
      </ul>
    </div>
  </div>
</div>

<nav>
  <div class="nav nav-tabs" id="import-tabs" role="tablist">
    <a class="nav-item nav-link <%=@import.state_machine.current_state == 'mapped' ? 'active' : '' %>" id="data-mapping-tab" data-toggle="tab" href="#data-mapping" role="tab" aria-controls="data-mapping" aria-selected="true">Data Mapping</a>
    <a class="nav-item nav-link <%= @import.state_machine.current_state == 'imported' ? 'active' : '' %>" id="import-results-tab" data-toggle="tab" href="#import-results" role="tab" aria-controls="import-results"
      aria-selected="false">Import Results</a>
  </div>
</nav>

<div class="tab-content" id="import-content">
  <div class="tab-pane fade <%=@import.state_machine.current_state == 'mapped' ? 'show active' : '' %>" id="data-mapping" role="tabpanel" aria-labelledby="data-mapping-tab">
    <h3 class="sr-only">Data Mapping</h3>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>CSV Header</th>
          <th>Solr Field Destination</th>
          <th>Delimited?</th>
        </tr>
      </thead>
      <tbody>
        <%- @import.mappings.each do |mapping| %>
          <tr>
            <td><%= mapping.source_header %></td>
            <td><%= mapping.destination_field %></td>
            <td><%= mapping.delimited %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="tab-pane fade <%= @import.state_machine.current_state == 'imported' ? 'show active' : '' %>" id="import-results" role="tabpanel" aria-labelledby="import-results-tab">
    <h3 class="sr-only">Import Results</h3>
    <h6>
      <span class='float-left mt-3'>
        <%== pagy_info(@pagy, 'documents'.pluralize(@pagy.count)) %>
      </span>
      <span class='float-right'>
        <%== pagy_bootstrap_nav(@pagy) %>
      </span>
    </h6>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Title</th>
          <th>Identifier</th>
          <th>State</th>
        </tr>
      </thead>
      <tbody>
        <% @import_documents.each_with_index do |doc, index| %>
          <tr>
            <td><%= doc.title %></td>
            <td><%= doc.friendlier_id %></td>
            <td>
              <%= doc.state_machine.current_state %>
              <% if doc.state_machine.current_state == "failed" %>
                <%= doc.state_machine.last_transition.metadata %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
